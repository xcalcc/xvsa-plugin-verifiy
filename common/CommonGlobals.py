#
#  Copyright (C) 2019-2020  XC Software (Shenzhen) Ltd.
#


import logging
from enum import Enum

report_host = "localhost"  # Default reporting host
report_port = 5775  # Default reporting port
use_jaeger = True
log_level = logging.INFO
old_tracer = None  # Set for initializing a fake tracer as an in-mem one first
old_spans = None  # Spans created in the old tracer
tracer = None  # Tracer, initially as none
jaeger_ready = False  # Is Jaeger Ready?
dir_stack = []  # Mutable Directory Stack
jaeger_service_name = "default-jaeger-common"
enable_memory_cache = False

SOURCE_CODE_ARCHIVE_FILE_NAME = "source_code.zip"
FILE_INFO_FILE_NAME = "fileinfo.json"
PREPROCESS_FILE_NAME = "preprocess.tar.gz"

GIT_METADATA_FILE_NAME = ".git"     # git metadata directory

#
# This should be synced with ScanService to properly display the name in UI
#
class TaskErrorNo(Enum):
    # TODO: align
    SUCCESS = 1000
    E_PARAMETERS = 10000
    E_JOB_TYPE_UNKNOWN = 10001
    E_SUBPROCESS_FAIL = 10003
    E_COLLECT_TAR_FAILED = 10004
    E_UPLOAD_PREPROCESS_TAR_FAILED = 10005
    E_REPORT_RESULT_FAILED = 10006
    E_API_INVOKE_FAIL = 10007
    E_XCALBUILD_NOT_FOUND = 10008
    E_CMD_RETURN_NONZERO = 10009
    E_JOB_TYPE_NONE = 10010
    E_XCALBUILD_FAIL = 10011
    E_JAVA_SCAN_FAIL = 10012
    E_FILE_INFO_PJ_NULL = 10013
    E_FILE_INFO_GATHER_FAIL = 10014
    E_PLUGIN_RETURN_NONZERO = 10015
    E_PLUGIN_EXEC_ERR = 10016
    E_PRESCAN_RESULT_DIR_NONEXIST = 10017
    E_NO_VIABLE_MIDDLE_RESULT = 10018
    E_NOT_FOUND_FILE = 10019
    E_COMPRESS_FAIL = 10020
    E_EXTRACT_UNKNOWN_FILEKIND = 10021
    E_CONFIG_PARM_ERROR = 10022
    E_CONFIG_SET_VALUE_WRONGKIND = 10023
    E_FILEUTIL_DIRSTACK = 10024
    E_FOLDER_PERMISSION_ERROR = 10025
    E_GIT_CLONE_FAILED = 10026
    E_FILEINFO_FOLDER_NONEXIST = 10027
    E_NO_I_FILE_GENERATED = 10028
    E_JAVA_PREPROCESS_NO_OUTPUT = 10029
    E_JAVA_HOME_NOTVALID = 10030
    E_JAVA_RT_JAR_NOT_READABLE = 10031
    E_JOB_CONFIG_APPEND_FAIL = 10032
    E_CHECK_CACHE_FILE_FAILED = 10033
    E_CHECK_CACHE_NONE_FILEID = 10034
    E_FILE_INFO_NO_UPLOADRESULTS = 10035
    E_FILE_INFO_NO_FILEID = 10036
    E_FOLDER_NOTEXIST = 10037
    E_VARIABLE_MUST_HAVE_VALUE = 10038
    E_SCAN_SERVICE_VERSION_MISMATCH = 10039
    E_FE_UTIL_DIR_NOTFOUND = 10040
    E_FE_UTIL_DIR_UNREADABLE = 10041
    E_FE_UTIL_LIB_NOTFOUND = 10042
    E_FE_UTIL_LIB_UNREADABLE = 10043
    E_FE_UTIL_JAR_NOTFOUND = 10044
    E_FE_UTIL_JAR_UNREADABLE = 10045
    E_JDK_JAR_NOTFOUND = 10046
    E_JDK_JAR_UNREADABLE = 10047
    E_JFE_RETURN_NONZERO = 10048
    E_RT_OBJ_NON_EXIST = 10049
    E_RT_TAR_NOT_EXIST = 10050
    E_CHECK_FILE_CACHED_NON_JSON = 10051
    E_SCAN_CONN_RES_NOT_EXIST = 10052
    E_FE_UTIL_CONN_NOTFOUND = 10053
    E_FE_UTIL_CONN_UNREADABLE = 10054
    E_SCAN_CONN_RET_NONZERO = 10055
    E_CONNECTOR_NOTFOUND = 10056
    E_CONNECTOR_UNREADABLE = 10057
    E_POLL_TASK_FAILED = 10058
    E_UPLOAD_FILE_FAILED = 10059
    E_INVALID_JSON_FORMAT = 10060

    E_CHECK_FILE_CACHED_NET_FAIL = 10101
    E_LOGIN_FAIL = 10102
    E_LOGIN_RESPONSE_NON_JSON = 10103

    E_SAVE_FILE_CACHED_NON_JSON = 10200
    E_SAVE_FILE_CACHED_NET_FAIL = 10201
    E_SAVE_FILE_CACHE_SERVER_FAIL = 10202
    E_SAVE_FILE_ID_NOT_FOUND = 10203

    # Java Plugin / Prescan Specific Errors
    E_JAVA_PRESCAN_PLUGIN_NOT_VIABLE = 10301
    E_JAVA_PREPROCESS_RESULT_DIR_NOT_EXIST = 10310

    # Common Error Code

    E_COMMON_FOLDER_NONEXIST = 12001
    E_COMMON_FOLDER_PERMISSION = 12002
    E_COMMON_TIMEOUT = 12003
    E_COMMON_FILE_NOT_EXIST = 12004
    E_COMMON_INVALID_CONTENT = 12005
    
    # Installation Related Error

    E_AGENT_CHECK_TYPE_NOT_SUPPORT = 14001
    E_SYS_DEPENDENCY_NOT_EXIST = 14002
    E_PY_DEPENDENCY_NOT_EXIST = 14003
    E_PLUGIN_TYPE_NOT_SUPPORT = 14004
    E_PLUGIN_INSTALLATION_FAILED = 14005
    E_COMPONENT_MISSING = 14006
    E_JAVA_HOME_NOT_FOUND = 14007
    E_NO_SUFFICIENT_MEMORY = 14008
    E_BEAR_INSTALLATION_FAILED = 14009

    # XcalScan Service

    E_NO_AGENT_CONN_TIMEOUT = 20000
    E_SCAN_TIME_EXCEED = 20001
    E_SCAN_UPLOAD_TIMEOUT = 20002
    E_QUEUEING_EXPIRED = 20101
    E_SCAN_SERVICE_STAGE_TIMEOUT = 20102

    # User Input Error

    USER_INPUT_ERR_BASE = 30000
    E_SOURCE_DIRECTORY_NOT_EXIST = 30001
    E_BUILD_MAIN_DIRECTORY_NOT_EXIST = 30002
    E_AGENT_NAME_INVALID = 30003
    E_JOB_QUEUE_NAME_INVALID = 30004
    E_NO_AGENT_TOKEN = 30005
    E_JAVA_PARSE_USER_ENVOPT = 30006
    USER_INPUT_ERR_END = 39999

    # Common Utilities

    E_UTIL_TAR_COMPRESS = 40001
    E_UTIL_UNKNOWN_ARCHIVE_TYPE = 40002
    E_UTIL_CONFOBJ_PARAM = 40003
    E_UTIL_CONFOBJ_TOKEN = 40004
    E_UTIL_CONFOBJ_USERCONTENT = 40005
    E_UTIL_CONFOBJ_SCANID = 40006
    E_UTIL_CONFOBJ_SCANFILE = 40007
    E_UTIL_CONFOBJ_PREPROCPATH = 40008
    E_UTIL_CONFOBJ_SET = 40009
    E_UTIL_EXPIRE_NONE_HOOKTYPE = 40020
    E_STAGE_NOT_RECOGNIZE = 40021
    E_UTIL_EXPIRE_UNKNOWN_LIST_NAME = 40022
    E_UTIL_EXPIRE_IGNORE_DURATION = 40023
    E_UTIL_ZIP_COMPRESS = 40050

    # XcalScan Scan Services

    E_SCAN_JOB_FAILED = 50001
    E_NO_PIPELINE = 50002
    E_PIPELINE_OFFSET = 50003
    E_SRV_JOBLISTEN_KAFKA_RECEIVE = 50004
    E_JOB_EXPIRE = 50005
    E_SRV_KAFKA_FAILED = 5006

    E_API_AGENT_PARAM_TARGET = 50010

    E_SRV_AGENT_INVOKE_KEY_IN_CONFIG = 51001
    E_SRV_AGENT_INVOKE_GITLAB = 51002
    E_SRV_AGENT_SRC_ADDRESS = 51003
    E_SRV_AGENT_NO_PREPROCESS_LOC = 51004
    E_SRV_AGENT_SSH_FAILED = 51005
    E_SRV_AGENT_SSH_PARAM = 51006
    E_SRV_FILE_SCP_SEND = 51007
    E_SRV_FILE_SCP_GET_FAIL = 51008
    E_SRV_GETPREPROC_NO_PRESCAN_RESULT = 51009
    E_SRV_AGENT_UNKNOWN = 51010
    E_SRV_AGENT_CHECK_CACHE = 51011
    E_SRV_XVSA_UNKNOWN_EXECTUTE_TYPE = 51012
    E_SRV_FLATTEN_OVERSIZE = 51013
    E_SRV_FLATTEN_FID_INVALID = 51014
    E_SRV_FLATTEN_PATH_FID_INVALID = 51015

    E_UTIL_CACHE_NONE_PARAM = 52001
    E_UTIL_CACHE_JSON_INVALID = 52002
    E_SETTING_SET_PARM_ERROR = 52003

    E_DOCKER_CONATINER_EXITNZERO = 55001
    E_DOCKER_NOIMAGEFOUND = 55002
    E_DOCKER_API_ERROR = 55003
    E_SRV_XVSA_EXECUTE_FAIL = 55010
    E_SRV_XVSA_DOCKER_FAIL = 55011

    E_SRV_UPLOAD_NO_V_FILE = 56001
    E_SRV_UPLOAD_V_NOT_READABLE = 56002
    E_SRV_UPLOAD_FILEINFO_NEXIST = 56003
    E_SRV_UPLOAD_FILEINFO_NOT_READABLE = 56004
    E_SRV_UPLOAD_V_FILE_OVERSIZE = 56010
    E_SRV_UPLOAD_FILEINFO_OVERSIZE = 56011

    E_CONNECT_API_LIST_SETTING = 57001
    E_CONNECT_API_UPLOAD_PROGRESS = 57002

    E_GET_CURRENT_USER_INFO_FAILED = 58001

    E_CREATE_PROJECT_FAILED = 59001
    E_GET_PROJECT_CONFIG_FAILED = 59002
    E_ADD_SCAN_TASK_FAILED = 59003
    E_CALL_SCAN_SERVICE_FAILED = 59004
    E_KEY_NOT_FOUND = 59005

    E_NO_SCAN_RESULT = 60001
    E_VERIFY_MAIN = 5600000
    E_VERIFY_JFE = 5600001
    E_VERIFY_LIB_NOT_EXIST = 5600002
    E_VERIFY_DIR_NOT_EXIST = 5600003

class Stage(Enum):
    PENDING = 1
    PREPARE_SCAN_TASK_PIPELINE = 2
    SCAN_QUEUE_PRESCAN = 3
    PREPARE_WORKER_PIPELINE = 4
    PRE_SCAN_QUEUE = 5
    AGENT_START = 6
    FETCH_SOURCE = 7
    PRE_PROCESS = 8
    COMPRESS_SOURCE_CODE = 9
    UPLOAD_SOURCE_CODE = 10
    COLLECT_FILE_INFO = 11
    UPLOAD_FILE_INFO = 12
    UPLOAD_PRE_PROCESS_INFO = 13
    AGENT_END = 14
    SCAN_QUEUE_GET_PRESCAN_RESULT = 15
    FETCH_PRE_PROCESS_INFO = 16
    SCAN_QUEUE_XVSA = 17
    SCAN_ENGINE_QUEUE = 18
    SCANNING = 19
    SCAN_QUEUE_IMPORT_RESULT = 20
    IMPORT_FILE_INFO = 21
    IMPORT_RESULT = 22
    SCAN_COMPLETE = 23


class Percentage(Enum):
    START = 10
    MIDDLE = 50
    END = 100


class Status(Enum):
    PENDING = 1
    PROCESSING = 2
    COMPLETED = 3
    FAILED = 4
    TERMINATED = 5